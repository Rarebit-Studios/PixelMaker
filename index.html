<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Add version meta tag -->
    <meta name="app-version" content="1.0.4">
    <!-- Add no-cache meta tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Pixel Maker - Version 1.0.4</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- PWA meta tags -->
    <meta name="theme-color" content="#363636">
    <meta name="description" content="A simple pixel art editor for creating pixel art (with makecode export)">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PixelArt">
    <meta name="application-name" content="PixelArt">
    
    <!-- PWA links -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <!-- Service Worker Registration with Version Check -->
    <script>
        // Disable right click context menu
        document.addEventListener('contextmenu', event => event.preventDefault());
        
       
        // Register service worker with version parameter
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    // Add version to service worker URL to force update
                    const registration = await navigator.serviceWorker.register('./sw.js?v=' + APP_VERSION, {
                        scope: './'
                    });
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available - force reload
                                window.location.reload(true);
                            }
                        });
                    });

                    // Check version mismatch on page load
                    const currentVersion = document.querySelector('meta[name="app-version"]').content;
                    const storedVersion = localStorage.getItem('app-version');
                    
                    if (storedVersion !== currentVersion) {
                        // Version mismatch - clear cache and reload
                        if ('caches' in window) {
                            caches.keys().then(names => {
                                names.forEach(name => {
                                    caches.delete(name);
                                });
                            });
                        }
                        localStorage.setItem('app-version', currentVersion);
                        window.location.reload(true);
                    }
                    
                    console.log('ServiceWorker registration successful with scope:', registration.scope);
                } catch (err) {
                    console.log('ServiceWorker registration failed:', err);
                }
            });
        }
    </script>
</head>
<body>
    <div class="version-display">v1.0.4</div>
    <div class="container">
        <div class="editor-container">

            <div class="editor-content">
                <div class="tools">

                    
                    <div class="tools-top-left">
                        <div id="miniPreview" class="mini-preview"></div>
                      
                    </div>

                    <div class="tools-top-middle">
                        <button id="pen" class="tool-button"><img src="Icon_Pen.Png" alt="Pen" class="tool-icon"></button>
                        <button id="eraser" class="tool-button"><img src="Icon_erase.Png" alt="Eraser" class="tool-icon"></button>
                        <button id="floodfill" class="tool-button"><img src="Icon_Fill.Png" alt="Fill" class="tool-icon"></button>
                        <button id="colorpicker" class="tool-button"><img src="Icon_Pick.Png" alt="Clear" class="tool-icon"></button>
                       
                        <button id="undo" class="tool-button"><img src="Icon_Arrow_2_Left.Png" alt="Undo" class="tool-icon"></button>
                        <button id="redo" class="tool-button"><img src="Icon_Arrow_2_Right.Png" alt="Redo" class="tool-icon"></button>
                        <button id="paste" class="tool-button"><img src="Icon_Paste.Png" alt="Paste" class="tool-icon"></button>
                      
                    </div>

                    <div class="tools-top-right">
                   
                        <input type="color" id="colorPicker" value="#000000">
                       
                    </div>

              
                 
                   
                   
                 
                
                  
                </div>
 
                <div class="main-editor">
                    <div class="color-palette left-palette"></div>
                    <div id="pixelGrid"></div>
                    <div class="color-palette right-palette"></div>
                </div>
                <div class="tools-bottom">

                  

                    <div class="tools-bottom-middle">
                        <div id="coordinates" class="coordinates-text">0,0</div>
                    <select id="resolutionSelector" class="resolution-selector">
                        <option value="8">8x8</option>
                        <option value="16" selected>16x16</option>
                        <option value="32">32x32</option>
        
                    </select>
                    <select id="paletteSelector" class="palette-selector">
                        <option value="default">Sweetie 16</option>
                        <option value="makecode">MakeCode</option>
                        <option value="steamlords">Steam Lords</option>
                        <option value="pico8">Pico-8</option>
                        <option value="cga">CGA</option>
                        <option value="na16">NA16</option>
                        <option value="gameboy">GameBoy</option>
                        <option value="grayscale">Grayscale</option>
                        <option value="pastel">Pastel</option> 
                    </select>
                    
                    <button id="save"><img src="Icon_Folder_Save.Png" alt="Pen" class="tool-icon"></button>
                    <button id="import"><img src="Icon_Folder_Open.Png" alt="Pen" class="tool-icon"></button>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    <button id="clear" class="tool-button"><img src="Icon_clear.Png" alt="Clear" class="tool-icon"></button>
                    <button id="exportMakeCode"><img src="makecode.png" alt="Pen" class="tool-icon"></button>
                    <button id="logoBtn" class="tool-button"><img src="logo.png" alt="Reality Boffins - Visit our website" class="tool-icon"></button>
                   </div>   

                
            
                    


               </div>
            </div>
        </div>
    </div>

    <!-- Add Modal Structures -->
        <!-- Modal Overlay (shared) -->
        <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5); z-index: 999;"></div>

        <!-- Clear Canvas Modal -->
        <div id="clearModal" class="modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000;
            text-align: center; min-width: 300px;">
            <h3 style="margin-top: 0; color: #333;">Clear Canvas</h3>
            <p style="margin: 10px 0; color: #666;">Are you sure you want to clear the canvas? This action can be undone.</p>
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                <button id="clearYes" 
                    style="background-color: #ff4444; color: white; border: none; padding: 8px 16px; 
                    border-radius: 4px; cursor: pointer;">Yes</button>
                <button id="clearNo" 
                    style="background-color: #18b2e0; color: white; border: none; padding: 8px 16px; 
                    border-radius: 4px; cursor: pointer;">No</button>
            </div>
        </div>

        <!-- Resolution Change Modal -->
        <div id="resolutionModal" class="modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
        background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000;
        text-align: center; min-width: 300px;">
            <h3 style="margin-top: 0; color: #333;">Change Resolution</h3>
            <p style="margin: 10px 0; color: #666;">Changing resolution will clear your current artwork. Continue?</p>
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                <button id="resolutionYes" 
                    style="background-color: #ff4444; color: white; border: none; padding: 8px 16px; 
                    border-radius: 4px; cursor: pointer;">Yes</button>
                <button id="resolutionNo" 
            style="background-color: #18b2e0; color: white; border: none; padding: 8px 16px; 
                    border-radius: 4px; cursor: pointer;">No</button>
            </div>
        </div>

    <!-- MakeCode Export Modal -->
        <div id="copyModal" class="modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000;
            text-align: center; min-width: 300px;">
            <h3 style="margin-top: 0; color: #333;">MakeCode Export</h3>
            <p style="margin: 10px 0; color: #666;">Sprite data copied to clipboard!</p>
            <p style="margin: 10px 0; color: #666;">You can now paste it into your MakeCode project.</p>
        </div>

    <script src="pixengine.js"></script>
</body>
</html>
